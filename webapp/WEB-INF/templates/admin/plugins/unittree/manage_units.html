<div id="left" >
    <div class="content-box">
    	<h2>#i18n{unittree.manageUnits.labelUnits}</h2>
    	${unitTree!}
        <#if listUnitActions?? && listUnitActions?has_content>
	    	<table>
	    		<tr>
	                <th width="20%">#i18n{unittree.manageUnits.labelActions}</th>
	            </tr>
	            <tr>
	                <td>
                		<#list listUnitActions as unitAction>
                			<a href="${unitAction.url!}?idUnit=${unit.idUnit!}">
                				<img src="${unitAction.iconUrl!}" alt="${unitAction.name!}" title="${unitAction.name!}" />
                			</a>
                		</#list>
	                </td>
	            </tr>
	    	</table>
		</#if>
		<br />
	</div>
</div>
<div id="right">
	<div class="content-box">
		<h2>#i18n{unittree.manageUnits.labelListUsers}</h2>
		
		<#-- SEARCH USER FORM-->
		<@searchAdminUsersForm urlAction="jsp/admin/plugins/unittree/ManageUnits.jsp" displayInDepthOption=true />
		
		<#-- LIST ASSIGNED USERS -->
		<form method="post" action="jsp/admin/plugins/unittree/ManageUnits.jsp">
			<input type="hidden" name="idUnit" value="${unit.idUnit!}" />
			<#assign additionnalAttribute = "&session=session&idUnit=" + unit.idUnit! + sort_search_attribute!>
			<table>
				<tr>
					<th>
						#i18n{unittree.manageUnits.labelFirstName}
						<@sort jsp_url="jsp/admin/plugins/unittree/ManageUnits.jsp" attribute="firstName${additionnalAttribute!}" />
					</th>
					<th>
						#i18n{unittree.manageUnits.labelLastName}
						<@sort jsp_url="jsp/admin/plugins/unittree/ManageUnits.jsp" attribute="lastName${additionnalAttribute!}" />
					</th>
					<th>
						#i18n{unittree.manageUnits.labelAccessCode}
						<@sort jsp_url="jsp/admin/plugins/unittree/ManageUnits.jsp" attribute="accessCode${additionnalAttribute!}" />
					</th>
					<th>
						#i18n{unittree.manageUnits.labelAssociatedUnit}
					</th>
					<th>#i18n{unittree.manageUnits.labelActions}</th>
				</tr>
				<#if listUsers?? && listUsers?has_content>
					<#list listUsers as user>
						<tr>
							<td>${user.firstName!}</td>
							<td>${user.lastName!}</td>
							<td>${user.accessCode!}</td>
							<td>
								<#if mapIdUserUnit["" + user.userId]??>
									<#assign userSubUnit = mapIdUserUnit["" + user.userId]>
									<a href="jsp/admin/plugins/unittree/ManageUnits.jsp?idUnit=${userSubUnit.idUnit!}">
										${userSubUnit.label!}
									</a>
								</#if>
							</td>
							<td>
								<#if listUnitUserActions?? && listUnitUserActions?has_content>
									<#list listUnitUserActions as unitUserAction>
										<a href="${unitUserAction.url!}?idUnit=${unit.idUnit!}&amp;idUser=${user.userId!}">
			                				<img src="${unitUserAction.iconUrl!}" alt="${unitUserAction.name!}" title="${unitUserAction.name!}" />
			                			</a>
									</#list>
								</#if>
							</td>
						</tr>
					</#list>
				</#if>
			</table>
			<p>
				<#if listUnitUserPluginActions?? && listUnitUserPluginActions?has_content>
					<#list listUnitUserPluginActions as unitUserPluginAction>
						<#if unitUserPluginAction.buttonTemplate?has_content>
							<#include unitUserPluginAction.buttonTemplate />
						</#if>
					</#list>
				</#if>
			</p>
		</form>
		<@paginationAdmin paginator=paginator />
		
		<#-- LIST OF SUB UNITS -->
		<h2>#i18n{unittree.manageUnits.labelListSubUnits}</h2>
		<#if listSubUnits?? && listSubUnits?has_content>
			<ul>
				<#list listSubUnits as subUnit>
					<li>
						<img src="images/admin/skin/plugins/unittree/units/unit.png" alt="#i18n{unittree.manageUnits.labelSubUnit}" title="#i18n{unittree.manageUnits.labelSubUnit}" />
						<a href="jsp/admin/plugins/unittree/ManageUnits.jsp?idUnit=${subUnit.idUnit!}">
							${subUnit.label!}
						</a>
						<br />
						${subUnit.description!}
					</li>
				</#list>
			</ul>
		<#else>
			<p>
				#i18n{unittree.manageUnits.labelNoSubUnits}
			</p>
			<br />
		</#if>
	</div>
</div>

<#-- JS for tree display -->
<script type="text/javascript"> 
	jQuery( function($) {
		// Set idunit
		var idunit = ${unit.idUnit!};
		
		// Set the cookie of jstree
		$.cookie( "jstree_select", "#node-" + idunit );
		$( "#tree" ).jstree( {
			"ui" : {
				"select_limit" : 1,
			},
			"themes" : {
				"theme" : "classic",
				"icons" : false
			},
			"cookies" : {
				"save_opened" : false,
			},
			"core" : { "initially_open" : [ "node-0" ] },
			"plugins" : [ "themes", "html_data", "cookies", "ui" ]
		} );
	});
</script>
