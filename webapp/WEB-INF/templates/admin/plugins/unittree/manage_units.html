<div class="span4">
   	<legend>#i18n{unittree.manageUnits.labelUnits}</legend>
   	<div class="well">
	   	${unitTree!}
		<#if listUnitActions?? && listUnitActions?has_content>
			<br />
			<table class="table">
	    		<tr>
	                <th>#i18n{unittree.manageUnits.labelActions}</th>
	            </tr>
	            <tr>
	                <td>
	               		<#list listUnitActions as unitAction>
	               			<a class="btn btn-primary btn-small" href="${unitAction.url!}?idUnit=${unit.idUnit!}" title="${unitAction.name!}">
	               				<i class="icon-white ${unitAction.icon!}">&nbsp;</i>
	               			</a>
	               		</#list>
	                </td>
	            </tr>
	    	</table>
		</#if>
	</div>
</div>
<div class="span7">
	<legend>#i18n{unittree.manageUnits.labelListUsers}</legend>
	
	<#-- SEARCH USER FORM-->
	<@searchAdminUsersForm urlAction="jsp/admin/plugins/unittree/ManageUnits.jsp" displayInDepthOption=true />
	
	<#-- LIST ASSIGNED USERS -->
	<form method="post" action="jsp/admin/plugins/unittree/ManageUnits.jsp">
		<input type="hidden" name="idUnit" value="${unit.idUnit!}" />
		
		<#if listUnitUserPluginActions?? && listUnitUserPluginActions?has_content>
			<div class="pull-right">
				<#list listUnitUserPluginActions as unitUserPluginAction>
					<#if unitUserPluginAction.buttonTemplate?has_content>
						<#include unitUserPluginAction.buttonTemplate />
					</#if>
				</#list>
			</div>
		</#if>
		<br />
		<br />
		
		<#assign additionnalAttribute = "&session=session&idUnit=" + unit.idUnit! + sort_search_attribute!>
		<table class="table table-striped table-condensed">
			<tr>
				<th>
					#i18n{unittree.manageUnits.labelFirstName}
					<@sort jsp_url="jsp/admin/plugins/unittree/ManageUnits.jsp" attribute="firstName${additionnalAttribute!}" />
				</th>
				<th>
					#i18n{unittree.manageUnits.labelLastName}
					<@sort jsp_url="jsp/admin/plugins/unittree/ManageUnits.jsp" attribute="lastName${additionnalAttribute!}" />
				</th>
				<th>
					#i18n{unittree.manageUnits.labelAccessCode}
					<@sort jsp_url="jsp/admin/plugins/unittree/ManageUnits.jsp" attribute="accessCode${additionnalAttribute!}" />
				</th>
				<th>
					#i18n{unittree.manageUnits.labelAssociatedUnit}
				</th>
				<th>#i18n{unittree.manageUnits.labelActions}</th>
			</tr>
			<#if listUsers?? && listUsers?has_content>
				<#list listUsers as user>
					<#if mapIdUserUnit["" + user.userId]??>
						<#assign userUnit = mapIdUserUnit["" + user.userId]>
					<#else>
						<#assign userUnit = unit>
					</#if>
					<tr>
						<td>${user.firstName!}</td>
						<td>${user.lastName!}</td>
						<td>${user.accessCode!}</td>
						<td>
							<a href="jsp/admin/plugins/unittree/ManageUnits.jsp?idUnit=${userUnit.idUnit!}">
								${userUnit.label!}
							</a>
						</td>
						<td>
							<#if listUnitUserActions?? && listUnitUserActions?has_content>
								<#list listUnitUserActions as unitUserAction>
									<a class="btn btn-small btn-primary" href="${unitUserAction.url!}?idUnit=${userUnit.idUnit!}&amp;idUser=${user.userId!}" title="${unitUserAction.name!}">
						            	<i class="icon-white ${unitUserAction.icon!}" >&nbsp;</i>
						            </a>
								</#list>
							</#if>
						</td>
					</tr>
				</#list>
			</#if>
		</table>
	</form>
	<@paginationAdmin paginator=paginator />
	
	<#-- LIST OF SUB UNITS -->
	<legend>#i18n{unittree.manageUnits.labelListSubUnits}</legend>
	<#if listSubUnits?? && listSubUnits?has_content>
		<ul>
			<#list listSubUnits as subUnit>
				<li>
					<img src="images/admin/skin/plugins/unittree/units/unit.png" alt="#i18n{unittree.manageUnits.labelSubUnit}" title="#i18n{unittree.manageUnits.labelSubUnit}" />
					<a href="jsp/admin/plugins/unittree/ManageUnits.jsp?idUnit=${subUnit.idUnit!}">
						${subUnit.label!}
					</a>
					<br />
					${subUnit.description!}
				</li>
			</#list>
		</ul>
	<#else>
		<p>
			#i18n{unittree.manageUnits.labelNoSubUnits}
		</p>
		<br />
	</#if>
	<br />
	<br />
</div>

<#-- JS for tree display -->

<script src="js/jquery/plugins/ui/jstree/jquery.cookie.js" type="text/javascript"></script>
<script src="js/jquery/plugins/ui/jstree/jquery.jstree.js" type="text/javascript"></script>
<script src="js/jquery/plugins/ui/jstree/jquery.hotkeys.js" type="text/javascript"></script>

<script type="text/javascript">
	jQuery( function($) {
		// Set idunit
		var idunit = ${unit.idUnit!};
		
		// Set the cookie of jstree
		$.cookie( "jstree_select", "#node-" + idunit );
		$( "#tree" ).jstree( {
			"ui" : {
				"select_limit" : 1,
			},
			"themes" : {
				"theme" : "classic",
				"icons" : false
			},
			"cookies" : {
				"save_opened" : false,
			},
			"core" : { "initially_open" : [ "node-0" ] },
			"plugins" : [ "themes", "html_data", "cookies", "ui" ]
		} );
	});
</script>
